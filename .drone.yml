---
kind: pipeline
name: default

platform:
  os: linux
  arch: amd64

steps:
- name: restore
  pull: true
  image: coreyja/rust-cache:rust
  settings:
    aws_access_key_id:
      from_secret: CACHE_AWS_ACCESS_KEY_ID
    aws_secret_access_key:
      from_secret: CACHE_AWS_SECRET_ACCESS_KEY
    cache_bucket: cache.dokku.coreyja
    cache_download: true

- name: build
  image: rust:latest
  commands:
  - rustc --version; cargo --version; rustup --version
  - rustup component add rustfmt
  - cargo fmt -- --check
  - cargo build --locked --all-targets
  environment:
    CARGO_HOME: /drone/src/.cargo_build

- name: cache
  pull: true
  image: coreyja/rust-cache:rust
  settings:
    aws_access_key_id:
      from_secret: CACHE_AWS_ACCESS_KEY_ID
    aws_secret_access_key:
      from_secret: CACHE_AWS_SECRET_ACCESS_KEY
    cache_bucket: cache.dokku.coreyja

- name: test
  image: rust:latest
  commands:
  - cargo test --locked
  environment:
    CARGO_HOME: /drone/src/.cargo_build

---
kind: signature
hmac: 0983c27ff7921087f2186c0cb0a445bb5dd0dce6afd010bae52a614ed509675a

...
