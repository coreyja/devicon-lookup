---
kind: pipeline
name: default

platform:
  os: linux
  arch: amd64

steps:
- name: restore
  pull: true
  image: coreyja/rust-cache:rust
  settings:
    aws_access_key_id:
      from_secret: CACHE_AWS_ACCESS_KEY_ID
    aws_secret_access_key:
      from_secret: CACHE_AWS_SECRET_ACCESS_KEY
    cache_bucket: cache.dokku.coreyja
    cache_download: true

- name: build
  image: rust:latest
  commands:
  - rustc --version; cargo --version; rustup --version
  - rustup component add rustfmt
  - cargo fmt -- --check
  - cargo build --locked --all-targets
  environment:
    CARGO_HOME: /drone/src/.cargo_build

- name: cache
  pull: true
  image: coreyja/rust-cache:yarn
  settings:
    aws_access_key_id:
      from_secret: CACHE_AWS_ACCESS_KEY_ID
    aws_secret_access_key:
      from_secret: CACHE_AWS_SECRET_ACCESS_KEY
    cache_bucket: cache.dokku.coreyja

- name: test
  image: rust:latest
  commands:
  - cargo test --locked
  environment:
    CARGO_HOME: /drone/src/.cargo_build

---
kind: signature
hmac: ca98f9a25ba725768db7138a0c7f065ea3af982f32f6c4174bdaa4394198f83b

...
